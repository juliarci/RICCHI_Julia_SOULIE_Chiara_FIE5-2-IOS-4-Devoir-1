---
title: "FIA5-2-IOS-5 Devoir 1"
author: "Adrien Wartelle"
date: "2026-01-11"
output:
  pdf_document: default
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: sentence
---

# Etude de cas sur l’analyse et la mesure de performance des Flux de Patients

## Introduction

Ce travail porte sur l'analyse des flux de patients sur un plateau mutualisé de consultations externes d'un hôpital.
L'objectif est de réaliser un diagnostic objectif de la performance organisationnelle du service d'urologie en s'appuyant sur les méthodes et outils d'analyse de flux vus précédemment ainsi que sur le langage R à travers l’environnement de RStudio.
La figure ci-dessous illustre les principaux flux ainsi que le Plan du plateau de consultations (voir fichiers PlanConsultations.pdf et ZoomURO.pdf consultables à partir <http://bit.ly/PlansCHUTlse>)

<!--<img src="illustrations/PlanUro.png" alt="Plan du plateau de consultations" width="600"/>-->

![Plan du plateau de consultations](illustrations/PlanUro.png "Plan du plateau de consultations") Afin de collecter des données sur les parcours suivis, les patients qui se sont présentés le 12/11/2015 ont été équipés d’une étiquette électronique (type RFID) qui a permis de tracer leurs parcours dans le plateau de consultation.
Les données collectées ont été fusionnées avec les données des outils de gestion des dossiers administratifs et médicaux utilisés par les personnels.
L'ensemble est disponible sous la forme d’un fichier log, illustré par le tableau suivant (voir annexe LogPatientUROseul_12112015.xlsx consultable à partir <http://bit.ly/logPatients>).

<!--<img src="illustrations/TableauLogPatients.png" alt="Vue du tableau de données de log patient" width="600"/>-->

![*Vue du tableau de données de log patient*](illustrations/TableauLogPatients.png "Vue du tableau de données de log patient")

Les différentes de ce tableau de données sont :

-   *ID* (Col A) : Identifiant du patient

-   *Timestamp start* (Col B) : horodatage entrée de zone ou salle

-   *Timestamp end* (Col C) : horodatage sortie de zone ou salle

-   *Activity_MACRO* (Col D) : Activité suivie et indice salle (i)

-   *Activity_DETAILS* (Col E) : Type d'activité

-   *Ress.Humaines* (Col F) : Ressources humaines administratives ou soignantes intervenant dans l'activité

-   *distance parcourues* (Col G) : Distance parcourue cumulée

-   *début/fin opX* (Col H à O) : horodatage début/fin de chaque opération de prise en charge par une ressource administrative ou soignante (maxi 4 opérations par activité).

## **Devoir 1 - Travail demandé** : Exploration de Données Exploratoires

Ce travail est à rendre pour le **25/01/2026** au format Rmd ou R (+pdf si besoin) avec pour titre "NOM_Prenom_FIE5-2-IOS-4-Devoir-1.\*"

Ce premier devoir consiste en une exploration initiale des données afin de : - Comprendre les données - Structurer les données - Effectuer une analyse descriptive des données - Synthétiser une vision du service d'Urologie

```{r include=FALSE}
library(tidyverse)
library(data.table)

load("local_data/trace_example_1.RData")
load("local_data/trace_example_final.RData")

```

### Question 1) Mise en forme des données (*Preprocessing*) (/6)

Avant toute forme d'analyse et de modélisation, une grande partie du travail réside dans la préparation des données.
Il faut ainsi mettre les données dans un format qui soit plus simple à exploiter.
Ici, on cherche à obtenir les données avec les colonnes / variables suivantes :

-   *ID* (character) : Identifiant du patient ou de l'acteur en chaîne de caractères

-   TYPE (factor) : Distingue le type d'agent par les facteurs PATIENT et ACTOR

-   CURRENT_LOCATION (character) : Identifie la localisation actuelle (ou source)

-   Les localisations ont été renommées avec :

    ```         
    c("Entree_Generale","Accueil_Prio_1","Accueil_General_1", "Accueil_General_2","Accueil_General_3","Accueil_Attente", "Sortie_Attente","Sortie_Bureau_1","Sortie_Bureau_2", "Sortie_Generale","Uro_Box_1","Uro_Box_2","Uro_Box_3", "Uro_Box_4","Uro_Box_5","Uro_Box_6","Uro_Box_7", "Uro_Bureau_Annonce_1","Uro_Bureau_IDE_1","Uro_Debimetrie_1", "Uro_Examen_1","Uro_Examen_2","Uro_Examen_3","Uro_Attente_1")
    ```

-   NEXT_LOCATION (character) : Prochaine localisation (lorsque l'agent est en déplacement)

-   CURRENT_OPERATION_NUMBER (numeric) : étape d'opération

-   WITH_1 (character) : agent avec lequel l'agent concerné est en train d'interagir (patient avec acteur ou acteur avec patient)

-   WITH_2 (character) : 2ème agent avec lequel l'agent concerné est en train d'interagir (patient avec acteur ou acteur avec patient)

-   DATETIME_BEGIN (datetime) : Date de début de l'état courant

-   DATETIME_END (datetime) : Date de fin de l'état courant et de début du prochain état

Voici un extrait de ce qu'il faut obtenir, ici filtrer sur le patient d'ID 8 :

```{r example trace}
trace_example_1 
```

#### Réponse :

*Entrez votre texte ici*

```{r answer 1.a}

# Set dataFrame with dataSet Log Patient URO
df <- read_excel("Log_Patient_URO_12112015.xlsx")
df

# See dataFrame column names
names(df)

# Change columns names to be traited
df1 <- df %>%
   rename(Ress_Humaines = `Ress. Humaines`,
        Timestamp_start = `Timestamp start`,
        Timestamp_end   = `Timestamp end`)

# Create column TYPE with PATIENT
df1 <- df1 %>%
  mutate(
    TYPE = "PATIENT"
    )
df1

# Copy dataframe
df2 <- copy(df1)

# Mapping old names with new names
ancien <- c(
  "Entrée des Consultations",
  "ACCUEIL.S_Attente_Accueil(1)",
  "ACCUEIL.Bureau_Accueil(3)",
  "URO.S_Attente_5(1)",
  "ACCUEIL.Bureau_Accueil(2)",
  "ACCUEIL.Bureau_Accueil(1)",
  "URO.Box_Consult(1)",
  "SORTIE_URO.File_Attente(1)",
  "ACCUEIL.Bureau_AccueilPRIO(1)",
  "SORTIE_URO.Bureau_Sortie(2)",
  "URO.Box_Consult(2)",
  "URO.Box_Consult(3)",
  "Sortie des Consultations",
  "URO.Box_Consult(4)",
  "URO.Salle_Débitmétrie(1)",
  "URO.Box_Consult(5)",
  "URO.Box_Consult(6)",
  "URO.Box_Consult(7)",
  "URO.Bureau_Annonce(1)",
  "URO.Salle_Examen(1)",
  "SORTIE_URO.Bureau_Sortie(1)",
  "URO.Bureau_IDE(1)",
  "URO.Salle_Examen(2)",
  "URO.Salle_Examen(3)"
)

nouveau <- c(
  "Entree_Generale","Accueil_Prio_1","Accueil_General_1", 
  "Accueil_General_2","Accueil_General_3","Accueil_Attente", 
  "Sortie_Attente","Sortie_Bureau_1","Sortie_Bureau_2", 
  "Sortie_Generale","Uro_Box_1","Uro_Box_2","Uro_Box_3", 
  "Uro_Box_4","Uro_Box_5","Uro_Box_6","Uro_Box_7", 
  "Uro_Bureau_Annonce_1","Uro_Bureau_IDE_1","Uro_Debimetrie_1", 
  "Uro_Examen_1","Uro_Examen_2","Uro_Examen_3","Uro_Attente_1"
)

# Substitution
df2$Activity_DETAILS <- factor(
  df2$Activity_DETAILS,
  levels = ancien,
  labels = nouveau
)
df2

# Verify the result
unique(df2$Activity_DETAILS)

# ASC timestamp
df3 <- df2 %>%
  arrange(Timestamp_start)
df3

# Create column CURRENT_LOCATION
df3 <- df3 %>%
  mutate(
    CURRENT_LOCATION = Activity_DETAILS
  )
df3

# Create column NEXT_LOCATION
df3 <- df3 %>% mutate(NEXT_LOCATION = lead(CURRENT_LOCATION))

df3


library(dplyr)

# Create column that indicates the current step for each patient.
df4 <- df3 %>%
  mutate(
    CURRENT_OPERATION_NUMBER = case_when(
      format(`début op1`, "%H:%M:%S") != "00:00:00" & format(`début op2`, "%H:%M:%S") == "00:00:00" ~ 1,
      format(`début op2`, "%H:%M:%S") != "00:00:00" & format(`début op3`, "%H:%M:%S") == "00:00:00" ~ 2,
      format(`début op3`, "%H:%M:%S") != "00:00:00" & format(`début op4`, "%H:%M:%S") == "00:00:00" ~ 3,
      format(`début op4`, "%H:%M:%S") != "00:00:00" ~ 4,
      TRUE ~ NA_integer_
    )
  )

df4

# Create columns WITH_1 et WITH_2
df5 <- df4 %>%
  mutate(
    agents_split = str_split(Ress_Humaines, " - "),
    WITH_1 = sapply(agents_split, function(x) if(length(x) >= 1) str_remove(x[1], "^Op\\d+ : ") %>% str_trim() else NA_character_),
    WITH_2 = sapply(agents_split, function(x) if(length(x) >= 2) str_remove(x[2], "^Op\\d+ : ") %>% str_trim() else NA_character_)
  ) %>%
  select(-agents_split)
df5
```

De plus, il vous est demandé d'identifier toutes les erreurs de données potentielles (s'il y en a) comme :

-   les valeurs manquantes avec la fonction *is_na()* (sans raison valable)

-   les valeurs aberrantes comme des distances trop grandes ou des temps trop longs

-   les valeurs incohérentes comme des chevauchements de dates ou des enchaînements incohérent d'activités

#### Réponse :

```         
Entrez votre texte ici
```

```{r answer 1.b}
#_Entrez votre code R ici_

library(readr)

df <- read_csv2("local_data/trace_example_final.csv")

df

# a) Comptage des valeurs manquantes par colonne
missing_summary <- sapply(df, function(x) sum(is.na(x)))
print("Missing values per column:")
print(missing_summary)

# -----------------------------
# b) Valeurs aberrantes
#    (distances trop grandes ou temps trop longs)
# -----------------------------

library(dplyr)

# Create a new data frame with activity duration (in minutes)
df_aberrant <- df %>%
  mutate(
    duration_min = as.numeric(difftime(DATETIME_END, DATETIME_BEGIN, units = "mins"))
  )

# Identify aberrant durations (negative or excessively long)
df_aberrant_time <- df_aberrant %>%
  filter(duration_min < 0 | duration_min > 480)

# Identify aberrant distances (negative or too large)
df_aberrant_distance <- df_aberrant %>%
  filter(DISTANCE_PARCOURUE < 0 | DISTANCE_PARCOURUE > 1000)

# -----------------------------
# c) Valeurs incohérentes
#    (chevauchements de dates ou enchaînements incohérents)
# -----------------------------

# Incoherent dates: end before begin
df_incoherent_dates <- df %>%
  filter(DATETIME_END < DATETIME_BEGIN)

# Overlapping activities for the same patient
df_overlaps <- df %>%
  arrange(ID, DATETIME_BEGIN) %>%
  group_by(ID) %>%
  mutate(previous_end = lag(DATETIME_END)) %>%
  filter(DATETIME_BEGIN < previous_end) %>%
  ungroup()

nrow(df_aberrant_time)
nrow(df_aberrant_distance)
nrow(df_incoherent_dates)
nrow(df_overlaps)

```

### Question 2) Dénombrements (/1)

Les premières analyses effectuées sur un jeu de données sont le plus souvent de simples dénombrement.

Ainsi il vous est demandé d'extraire les nombres : (*attention à la façon de compter*)

-   Nombre de patient

-   Nombre d'acteur

-   Nombre d’activités générales et détaillées

N'hésitez pas à discuter brièvement de ces nombres notamment en les comparant.

#### Réponse :

*Entrez votre texte ici*

```{r answer 2}
#_Entrez votre code R ici_
library(dplyr)

# a) Nombre de patients uniques
df_patients <- df %>%
  filter(TYPE == "PATIENT") %>%
  distinct(ID)

n_patients <- nrow(df_patients)

# b) Nombre d'acteurs uniques
df_actors <- df %>%
  filter(TYPE == "ACTOR") %>%
  distinct(ID)

n_actors <- nrow(df_actors)


# Nombre d'activités générales
df_counts <- read_excel("Log_Patient_URO_12112015.xlsx")
df_activities_general <- df_counts %>%
  distinct(Activity_MACRO)
n_activities_general <- nrow(df_activities_general)

# Nombre d'activités détaillées
df_activities_detailed <- df_counts %>%
  distinct(Activity_DETAILS)
n_activities_detailed <- nrow(df_activities_detailed)

# Résumé
summary_counts <- data.frame(
  Indicator = c(
    "Number of patients",
    "Number of actors",
    "Number of general activities",
    "Number of detailed activities"
  ),
  Value = c(
    n_patients,
    n_actors,
    n_activities_general,
    n_activities_detailed
  )
)

summary_counts
```

### Question 3) Analyse du patient le plus long (/1)

Il est souvent utile d'identifier les cas les plus extrêmes dans une population.

Ici, il vous est demandé d'identifier le patient avec le plus long temps de séjour et de :

-   de calculer son temps de séjour total

-   de calculer sa distance totale parcourue

-   de tenter d'analyser la cause de cette longueur, ou du moins de constater où se situe les phases responsables dans son parcours

N'hésitez pas à discuter brièvement de son parcours.

#### Réponse :

*Entrez votre texte ici*

```{r answer 3}
#_Entrez votre code R ici_
```

### Question 4) Analyse des temps (/4)

On peut ensuite partir sur une analyse globale plus poussée sur :

-   Les temps de séjour et d'attente des patients

-   Les temps d'activité

Vous êtes libres d'aller explorer différents indicateurs, hypothèses de distributions (lois de probabilités).
Notamment quel ratio de temps les patients passent-ils à attendre ?
Il est fortement recommandé d'utiliser des plots pour votre exploration.
N'hésitez pas à faire ressortir les faits les plus marquant et à discuter brièvement des distributions que vous observerez.

#### Réponse :

*Entrez votre texte ici*

```{r answer 4}
#_Entrez votre code R ici_
```

### 5) Analyse du niveau d'occupation (/4)

Au delà des temps, l'analyse de la congestion d'un système se fait sur le niveau d'occupation.
Il vous est demandé d'identifier et si pertinent d'illustrer :

-   le niveau d'occupation à chaque instant de la journée analysée puis lissé sur 2h

-   le niveau d'occupation par blocs de 2h

-   le niveau d'occupation moyen sur la journée

L'évolution du niveau d'occupation étant une conséquence directe des arrivées et des départs.
Il vous est demandé de faire les mêmes analyses sur le nombre d'arrivées et de départs au cours de la journée et de le mettre en lien avec le niveau d'occupation.

#### Réponse :

*Entrez votre texte ici*

```{r answer 5}
#_Entrez votre code R ici_
```

### 6) Analyse de l'activité des acteurs (/4)

De manière similaire avec la question 3 pour le patient le plus long, il vous est demandé d'analyser l'activité des acteurs par type d'acteur.
On considéra que les acteurs arrivent dans le service 5 min avant leur première activité et partent 5 min après leur dernière activité.

#### Réponse :

*Entrez votre texte ici*

```{r answer 6}
#_Entrez votre code R ici_
```
